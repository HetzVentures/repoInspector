
from datetime import datetime
from sqlmodel import Session
from models import RepositoryUser, Repository
from sqlalchemy import func, desc, inspect
import os
import csv
import json
import logging
import zipfile
from os.path import basename
import urllib.parse
import pdfkit

class MessageCreator:

    def __init__(self, session: Session, repo_id: int):
        self.session = session
        self.repo_id = repo_id
        self.logger = logging.getLogger('MESSAGE CREATION')
        self.repo = session.query(Repository).where(Repository.id == repo_id).first()
        self.temp_path = f'temp/repo_{self.repo_id}'

    def create_message(self) -> tuple:

        rows = self.session.query(RepositoryUser).where(RepositoryUser.repository_id == self.repo_id).all()

        if rows:
            file_path = f'{self.temp_path}.csv'
            json_file_path = f'{self.temp_path}.json'
            pdf_file_path = f'{self.temp_path}.pdf'
            message_text, report_content = self.create_message_text()
            message_html = f'<head><link href="https://db.onlinewebfonts.com/c/1ae01d7899d3988cd6f5edd794a89d27?family=Brutal+Type+Light" rel="stylesheet"><link href="https://db.onlinewebfonts.com/c/0964446ac2793b90c9a3e49de5a3323f?family=Brutal+Type" rel="stylesheet"><style>\
            #message-summary-settings-item {{vertical-align:inherit !important;}}\
            #message-summary-settings-icon {{margin: 8px 3px 0 0 !important;}}\
            @media (min-width: 768px) {{\
            #message-container {{ margin-top: 40px !important; margin-bottom: 40px !important; border-radius: 10px;}}\
            #message-main-logo-wrapper {{padding-left: 40px !important;}}\
            #message-extra-logo-wrapper {{padding-right: 40px !important;}}\
            #message-main-logo {{margin: 40px 0 !important; max-width: 400px !important;}}\
            #message-extra-logo {{margin: 40px 0 !important; max-width: 120px !important;}}\
            #message-greeting-wrapper, #message-vote-wrapper, #message-progressbar-wrapper, #message-stars-chart-wrapper, #message-issues-chart-wrapper {{padding: 0 40px 30px !important;}}\
            #message-main-text, #message-link, #message-summary-settings-text, #message-progressbar-header-text {{font-size: 22px !important;}}\
            #message-summary-title, #accent-main-field, #message-location-full-wrapper, #message-location-left-wrapper, #message-repo-info-stars, #message-repo-health-title {{padding: 0 0 30px 40px !important;}}\
            #message-summary-settings, #accent-extra-field, #message-location-right-wrapper, #message-repo-info-forks, #message-repo-health-items {{padding: 0 40px 30px 0 !important;}}\
            #message-summary-settings-icon {{width: 18px !important; height: 18px !important; margin:4px 5px 0 0 !important;}}\
            #main-field, #message-progressbar-header-title {{padding: 0 0 15px 40px !important;}}\
            #extra-field, #message-progressbar-header-value {{padding: 0 40px 15px 0 !important;}}\
            #message-location-text, #message-accent-info-text, #message-info-text {{font-size: 18px !important;}}\
            #message-info-item {{padding: 5px 15px !important;}}}}\
            </style></head><table id="message-body" class="message-body" style="background: #f6f9fd; border-collapse: collapse; border-spacing: 0; color:#0a0a0a; font-family: Brutal Type, sans-serif; height: 100vh; min-height: 100vh; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; width: 100%"><tbody><tr style="padding: 0; text-align:left; vertical-align: top"><td align="center" valign="top" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; font-family: Brutal Type, sans-serif; hyphens:auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word"><center style="width: 100%"><table id="message-container" align="center" class="message-container" style="margin: 0 auto; background-color: #fff; border-collapse: collapse; border-spacing: 0; float: none; height: 100%; padding: 0; text-align: center; vertical-align: top; width: 100%; max-width: 800px"><tbody><td style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin:0; border-collapse: collapse !important; box-sizing: border-box; color:#0a0a0a; font-family: Brutal Type, sans-serif; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word">{message_text}</td></tbody></table></center></td></tr></tbody></table>'
            self.create_csv(
                file_path=file_path,
                rows=rows,
                repo_name=self.repo.name
            )
            self.create_json(
                file_path=json_file_path,
                rows=rows
            )
            self.create_pdf(
                file_path=pdf_file_path,
                html=report_content
            )
        else:
            file_path = None
            json_file_path = None
            html = 'Nothing was found by session'

        archive_path = self.create_archive(
            file_path=file_path,
            json_file_path=json_file_path,
            pdf_file_path=pdf_file_path,
        )

        return message_html, archive_path

    def create_archive(
            self,
            file_path: str,
            json_file_path: str,
            pdf_file_path: str,
    ) -> str:
        try:
            archive_path = f'{self.temp_path}.zip'

            with zipfile.ZipFile(archive_path, 'w', zipfile.ZIP_DEFLATED) as archive:
                archive.write(file_path, basename(file_path))
                archive.write(json_file_path, basename(json_file_path))
                archive.write(pdf_file_path, basename(pdf_file_path))

            return archive_path
        except BaseException:
            return self.create_archive(
                file_path=file_path,
                json_file_path=json_file_path,
                pdf_file_path=pdf_file_path,
            )

    def clear_temp(self):
        os.remove(f'{self.temp_path}.csv')
        os.remove(f'{self.temp_path}.json')
        os.remove(f'{self.temp_path}.zip')
        os.remove(f'{self.temp_path}.pdf')

    @staticmethod
    def create_csv(
            file_path: str,
            rows: list,
            repo_name: str
    ) -> None:
        today = datetime.today().strftime('%Y-%m-%d')
        with open(file_path, 'w', newline='', encoding='utf-8') as csv_file:
            writer = csv.writer(csv_file)
            inst = inspect(RepositoryUser)
            keys = [c_attr.key for c_attr in inst.mapper.column_attrs]
            headers = [c_attr.key for c_attr in inst.mapper.column_attrs]
            headers.insert(0, 'scan_date')
            headers.insert(0, 'repository_name')
            headers_to_remove = []

            for header_to_remove in headers_to_remove:
                if header_to_remove in headers:
                    headers.remove(header_to_remove)

            writer.writerow(headers)

            for row in rows:
                row_to_write = list()

                for key in keys:
                    row_to_write.append(getattr(row, key))

                row_to_write.insert(0, today)
                row_to_write.insert(0, repo_name)
                writer.writerow(row_to_write)

    @staticmethod
    def create_json(
            file_path: str,
            rows: list,
    ) -> None:
        json_data = json.dumps([r.dict() for r in rows], ensure_ascii=False, indent=4, default=str)

        with open(file_path, 'w', newline='', encoding='utf-8') as file:
            file.write(json_data)



    @staticmethod
    def create_pdf(
            file_path: str,
            html: str,
    ) -> None:
        # FIXME: Add the actual base URL from customer`s server for CSS file
        styled_html = f'<html><head><link rel="stylesheet" type="text/css" href="http://127.0.0.1:8000/static/css/report.css"><link href="https://db.onlinewebfonts.com/c/b3823b7c622063a0b860fc0123b9c1da?family=Brutal+Type+W00+Light" rel="stylesheet"><link href="https://db.onlinewebfonts.com/c/0964446ac2793b90c9a3e49de5a3323f?family=Brutal+Type" rel="stylesheet"></head><body><div class="report">{html}</div></body></html>'
        pdfkit.from_string(styled_html, file_path)

    def create_message_text(self) -> tuple:
        session = self.session
        repo_id = self.repo_id

        total_users = session.query(RepositoryUser.id).where(RepositoryUser.repository_id == repo_id).count()
        
        organizations_total = session.query(RepositoryUser.id).where(RepositoryUser.repository_id == repo_id, 
                                            RepositoryUser.company.is_not(None)).count()
        
        organizations_percent = "{:.2f}".format(organizations_total / total_users * 100)
        
        users_with_email = session.query(RepositoryUser.id).where(RepositoryUser.repository_id == repo_id, 
                                        RepositoryUser.email.is_not(None)).count()
        
        users_with_email_percent = "{:.2f}".format(users_with_email / total_users * 100)
        
        company_summary = session.query(RepositoryUser.company, func.count(RepositoryUser.company).label("count"))\
            .where(RepositoryUser.repository_id == repo_id).group_by(RepositoryUser.company).order_by(desc('count')).all()
        
        country_summary = session.query(RepositoryUser.country, func.count(RepositoryUser.country).label("count"))\
            .where(RepositoryUser.repository_id == repo_id).group_by(RepositoryUser.country).order_by(desc('count')).all()

        real_users = session.query(RepositoryUser.id).where(RepositoryUser.repository_id == repo_id, 
                                            RepositoryUser.real_user.is_(True)).count()

        active_users = session.query(RepositoryUser.id).where(RepositoryUser.repository_id == repo_id, 
                                    RepositoryUser.active_user.is_(True)).count()

        # Email content

        # FIXME: Add the real URL from customer`s server for logos
        message_text = '<table id="message-header" class="message-header" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width:100%"><tbody><tr style="padding: 0; text-align: left; vertical-align: top"><th id="message-main-logo-wrapper" class=message-main-logo-wrapper small-9 large-4 columns first" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0 auto; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0; text-align: left; vertical-align: top; width: 177.3333333333px; word-wrap: break-word"><table style="border-collapse: collapse; border-spacing: 0; padding:0; text-align: left; vertical-align: top; width: 100%"><tbody><tr style="padding: 0; text-align: left; vertical-align: top"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin:0; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: start; vertical-align: top; word-wrap: break-word"><a href="https://github.com/HetzVentures/repoInspector" id="message-main-logo" class="message-main-logo" style="color: #2199e8; display: inline-block; line-height: 1.3; margin: 25px 0; max-width: 250px; padding:0; text-align: left; text-decoration: none"><img src="https://i.ibb.co/682p9Dx/main-logo.png" alt="logo" style="-ms-interpolation-mode: bicubic; border: none; clear: both; display: block; max-width: 100%; outline: 0; text-decoration: none; width: auto"></a></th></tr></tbody></table></th><th id="message-extra-logo-wrapper" class="message-extra-logo-wrapper small-3 large-2 columns last" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0 auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0; text-align: left; vertical-align: top; width:80.6666666667px; word-wrap: break-word"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%"><tbody><tr style="padding: 0; text-align: left; vertical-align: top"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: end; vertical-align: top; word-wrap: break-word"><a href="https://github.com/HetzVentures/repoInspector" id="message-extra-logo" class="message-extra-logo" style="color: #2199e8; display: inline-block; line-height: 1.3; margin: 25px 0; max-width: 80px; padding: 0; text-align: left; text-decoration: none"><img src="https://i.ibb.co/YBYDsxT/hetz-logo.png" alt="extra-logo" style="-ms-interpolation-mode: bicubic; border:none; clear:both; display:block; max-width:100%; outline:0; text-decoration: none; width: auto"></a></th></tr></tbody></table></th></tr></tbody></table>'
        message_text = message_text + f'<table class="row greeting" id="message-greeting" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th id="message-greeting-wrapper" class="small-12 large-12 columns first last" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 20px; text-align: left; vertical-align: top; width: 100%; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><p id="message-main-text" class="main-text" style="margin: 0; color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">Hi, there! Below (and attached) is your report for repository <a href="https://github.com/{self.repo.name}" id="message-link" class="main-link" style="color: #2540f2; display: inline-block; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0; padding: 0; text-align: left; text-decoration: none; transition: all 0.2s linear; white-space: wrap;">https://github.com/{self.repo.name}</a></p></th><th class="expander" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0 !important; text-align: left; vertical-align: top; visibility: hidden; width: 0; word-wrap: break-word;"></th></tr></tbody></table></th></tr></tbody></table>'
        message_text = message_text + f'<table class="row vote" id="message-vote" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th id="message-vote-wrapper" class="small-12 large-12 columns first last" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 20px; text-align: left; vertical-align: top; width: 100%; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><p id="message-main-text" class="main-text" style="margin: 0; color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">Thanks for using repoInspector! <a href="https://github.com/HetzVentures/repoInspector" id="message-link" class="main-link" style="color: #2540f2; display: inline-block; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0; padding: 0; text-align: left; text-decoration: none; transition: all 0.2s linear; white-space: wrap;">Give us a Star</a></p></th><th class="expander" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0 !important; text-align: left; vertical-align: top; visibility: hidden; width: 0; word-wrap: break-word;"></th></tr></tbody></table></th></tr></tbody></table>'
        
        settings = json.loads(self.repo.settings)

        def email_setting_status(v):
            # FIXME: Add the actual URL from customer`s server for icons
            return "https://i.ibb.co/SQDZ9Qw/check-icon.png" if v else "https://i.ibb.co/mhPZ4gp/cross-icon.png"

        email_settings_content = f'<div class="summary-settings__item" id="message-summary-settings-item" style="align-items: center; display: inline-flex; gap: 5px;"><p class="summary-settings__text" id="message-summary-settings-text" style="margin: 0; color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">Settings:</p></div>\
            <div class="summary-settings__item" id="message-summary-settings-item" style="align-items: center; display: inline-flex; gap: 5px; margin-left: 5px;"><img class="summary-settings__icon" id="message-summary-settings-icon" src={email_setting_status(settings["stars"])} alt="check-icon" style="-ms-interpolation-mode: bicubic; clear: both; display: block; height: 12px; margin-bottom: 2px; max-width: 100%; outline: none; text-decoration: none; width: 12px;"><p class="summary-settings__text" id="message-summary-settings-text" style="margin: 0; color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">Stars</p></div>\
            <div class="summary-settings__item" id="message-summary-settings-item" style="align-items: center; display: inline-flex; gap: 5px; margin-left: 5px;"><img class="summary-settings__icon" id="message-summary-settings-icon" src={email_setting_status(settings["forks"])} alt="check-icon" style="-ms-interpolation-mode: bicubic; clear: both; display: block; height: 12px; margin-bottom: 2px; max-width: 100%; outline: none; text-decoration: none; width: 12px;"><p class="summary-settings__text" id="message-summary-settings-text" style="margin: 0; color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">Forks</p></div>\
            <div class="summary-settings__item" id="message-summary-settings-item" style="align-items: center; display: inline-flex; gap: 5px; margin-left: 5px;"><img class="summary-settings__icon" id="message-summary-settings-icon" src={email_setting_status(settings["sample"])} alt="cross-icon" style="-ms-interpolation-mode: bicubic; clear: both; display: block; height: 12px; margin-bottom: 2px; max-width: 100%; outline: none; text-decoration: none; width: 12px;"><p class="summary-settings__text" id="message-summary-settings-text" style="margin: 0; color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">Sample</p></div>'
        
        message_text = message_text + f'<table class="row summary" id="message-summary" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th id="message-summary-title" class="small-2 large-4 columns first" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 20px; text-align: left; vertical-align: top; width: 177.3333333333px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><p class="main-text" id="message-main-text" style="margin: 0; color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">Summary</p></th></tr></tbody></table></th><th class="summary__settings summary-settings small-10 large-12 columns last" id="message-summary-settings" valign="middle" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 20px; text-align: left; vertical-align: middle; width: 564px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: end; vertical-align: top; word-wrap: break-word;">{email_settings_content}</th><th class="expander" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0 !important; text-align: left; vertical-align: top; visibility: hidden; width: 0; word-wrap: break-word;"></th></tr></tbody></table></th></tr></tbody></table>'
    
        if settings.get('sample'):
            message_text = message_text + f'<table class="row message-field" id="message-field" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="main-field small-8 large-8 columns first" id="accent-main-field" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 20px; text-align: left; vertical-align: top; width: 370.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><p class="main-text" id="message-main-text" style="color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">Sample percent:</p></th></tr></tbody></table></th><th class="extra-field small-2 large-2 columns last" id="accent-extra-field" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 20px; text-align: left; vertical-align: top; width: 80.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: end; vertical-align: top; word-wrap: break-word;"><p class="main-text" id="message-main-text" style="color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">{settings["samplePercent"]}%</p></th></tr></tbody></table></th></tr></tbody></table>'
        
        stars_per_month = 0

        if "last_month_stars" in self.repo:
            stars_per_month = round((self.repo.last_month_stars / self.repo.stargazers_count) * 100, 2)

        message_text = message_text + f'<table class="row message-field" id="message-field" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="main-field small-8 large-8 columns first" id="accent-main-field" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 20px; text-align: left; vertical-align: top; width: 370.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><p class="main-text" id="message-main-text" style="color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">Total number of profiles inspected:</p></th></tr></tbody></table></th><th class="extra-field small-2 large-2 columns last" id="accent-extra-field" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 20px; text-align: left; vertical-align: top; width: 80.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: end; vertical-align: top; word-wrap: break-word;"><p class="main-text" id="message-main-text" style="color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">{total_users}</p></th></tr></tbody></table></th></tr></tbody></table>'
        message_text = message_text + f'<table class="row message-field" id="message-field" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="main-field small-8 large-8 columns first" id="main-field" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 10px; text-align: left; vertical-align: top; width: 370.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><p class="main-text" id="message-main-text" style="color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">Issues:</p></th></tr></tbody></table></th><th class="extra-field small-2 large-2 columns last" id="extra-field" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 10px; text-align: left; vertical-align: top; width: 80.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: end; vertical-align: top; word-wrap: break-word;"><p class="main-text" id="message-main-text" style="color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">{self.repo.issues_count}</p></th></tr></tbody></table></th></tr></tbody></table>'
        message_text = message_text + f'<table class="row message-field" id="message-field" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="main-field small-8 large-8 columns first" id="main-field" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 10px; text-align: left; vertical-align: top; width: 370.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><p class="main-text" id="message-main-text" style="color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">Pull requests:</p></th></tr></tbody></table></th><th class="extra-field small-2 large-2 columns last" id="extra-field" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 10px; text-align: left; vertical-align: top; width: 80.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: end; vertical-align: top; word-wrap: break-word;"><p class="main-text" id="message-main-text" style="color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">{self.repo.pull_requests_count}</p></th></tr></tbody></table></th></tr></tbody></table>'
        message_text = message_text + f'<table class="row message-field" id="message-field" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="main-field small-8 large-8 columns first" id="main-field" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 10px; text-align: left; vertical-align: top; width: 370.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><p class="main-text" id="message-main-text" style="color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">Contributors:</p></th></tr></tbody></table></th><th class="extra-field small-2 large-2 columns last" id="extra-field" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 10px; text-align: left; vertical-align: top; width: 80.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: end; vertical-align: top; word-wrap: break-word;"><p class="main-text" id="message-main-text" style="color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">{self.repo.contributors_count}</p></th></tr></tbody></table></th></tr></tbody></table>'
        message_text = message_text + f'<table class="row message-field" id="message-field" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="main-field small-8 large-8 columns first" id="main-field" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 10px; text-align: left; vertical-align: top; width: 370.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><p class="main-text" id="message-main-text" style="color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">Watchers:</p></th></tr></tbody></table></th><th class="extra-field small-2 large-2 columns last" id="extra-field" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 10px; text-align: left; vertical-align: top; width: 80.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: end; vertical-align: top; word-wrap: break-word;"><p class="main-text" id="message-main-text" style="color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">{self.repo.watchers_count}</p></th></tr></tbody></table></th></tr></tbody></table>'
        message_text = message_text + f'<table class="row message-field" id="message-field" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="main-field small-8 large-8 columns first" id="main-field" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 10px; text-align: left; vertical-align: top; width: 370.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><p class="main-text" id="message-main-text" style="color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">Stars added per month:</p></th></tr></tbody></table></th><th class="extra-field small-2 large-2 columns last" id="extra-field" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 10px; text-align: left; vertical-align: top; width: 80.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: end; vertical-align: top; word-wrap: break-word;"><p class="main-text" id="message-main-text" style="color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">{stars_per_month}%</p></th></tr></tbody></table></th></tr></tbody></table>'
        message_text = message_text + f'<table class="row message-field" id="message-field" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="main-field small-8 large-8 columns first" id="main-field" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 10px; text-align: left; vertical-align: top; width: 370.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><p class="main-text" id="message-main-text" style="color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">Total forks / total stars:</p></th></tr></tbody></table></th><th class="extra-field small-2 large-2 columns last" id="extra-field" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 10px; text-align: left; vertical-align: top; width: 80.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: end; vertical-align: top; word-wrap: break-word;"><p class="main-text" id="message-main-text" style="color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">{round(self.repo.forks_count / self.repo.stargazers_count, 2)}</p></th></tr></tbody></table></th></tr></tbody></table>'
        message_text = message_text + f'<table class="row message-field" id="message-field" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="main-field small-8 large-8 columns first" id="accent-main-field" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 20px; text-align: left; vertical-align: top; width: 370.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><p class="main-text" id="message-main-text" style="color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">Pull requests merged LTM:</p></th></tr></tbody></table></th><th class="extra-field small-2 large-2 columns last" id="accent-extra-field" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 20px; text-align: left; vertical-align: top; width: 80.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: end; vertical-align: top; word-wrap: break-word;"><p class="main-text" id="message-main-text" style="color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">{self.repo.pull_requests_merged_ltm}</p></th></tr></tbody></table></th></tr></tbody></table>'
        
        # FIXME: Add actual rating from server
        repo_rating = 78

        # REPO RATING FIELD
        message_text = message_text + f'<table class="row message-field" id="message-field" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="main-field small-8 large-8 columns first" id="accent-main-field" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 20px; text-align: left; vertical-align: top; width: 370.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><p class="main-text" id="message-main-text" style="color: #2540f2; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">Repository rating:</p></th></tr></tbody></table></th><th class="extra-field small-2 large-2 columns last" id="accent-extra-field" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 20px; text-align: left; vertical-align: top; width: 80.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: end; vertical-align: top; word-wrap: break-word;"><p class="main-text" id="message-main-text" style="color: #2540f2; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">{repo_rating}</p></th></tr></tbody></table></th></tr></tbody></table>'

        # common limit for shown data in charts
        data_limit = -24

        # stargazers chart
        stars_history_dict = json.loads(self.repo.stars_history)

        if stars_history_dict:
            stars_chart_labels = sorted(stars_history_dict.keys())
            stars_chart_dataset = [stars_history_dict[key]["count"] for key in stars_chart_labels]
            stars_chart_data = {
                "type": "line",
                "data": {
                    "labels": stars_chart_labels[data_limit:],
                    "datasets": [
                        {
                            "label": "",
                            "data": stars_chart_dataset[data_limit:],
                            "backgroundColor": 'rgba(55, 119, 255, 0.5)',
                            "borderColor": 'rgb(55, 119, 255)',
                            "fill": 'start',
                            "lineTension": 0.4,
                        }
                    ]
                },
                "options": {
                    "legend": { "display": False },
                    "scales": {
                        "xAxes": [{
                            "gridLines": {
                                "display": False
                            },
                            "ticks": {
                                "fontColor": '#2335f3',
                            },
                        }],
                        "yAxes": [{
                            "ticks": {
                                "fontColor": '#2335f3',
                            },
                        }]
                    }
                }
            }

            stars_chart_data_str = json.dumps(stars_chart_data)
            stars_chart_encoded_data = urllib.parse.quote(stars_chart_data_str)
            stars_chart_data_url = f"https://quickchart.io/chart?width=800&height=350&devicePixelRatio=1&c={stars_chart_encoded_data}"

            stars_chart_data_string = json.dumps(stars_chart_data)

            message_text = message_text + f'<table class="row message-stars" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="message-stars-chart-wrapper small-12 large-12 columns first last" id="message-stars-chart-wrapper" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0 auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 20px; text-align: left; vertical-align: top; width: 564px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><img class="message-stars-chart" id="message-stars-chart" src="{stars_chart_data_url}" alt="stars-chart" style="-ms-interpolation-mode: bicubic; clear: both; display: block; max-width: 100%; outline: none; text-decoration: none; width: 100%;"></th><th class="expander" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0 !important; text-align: left; vertical-align: top; visibility: hidden; width: 0; word-wrap: break-word;"></th></tr></tbody></table></th></tr></tbody></table>'

        message_text = message_text + f'<table class="row message-repo-info" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="message-repo-info-stars small-6 large-6 columns first" id="message-repo-info-stars" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 20px; text-align: left; vertical-align: top; width: 274px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><div class="message-info-item" id="message-info-item" style="border: 2px solid #2335f3; border-radius: 30px; box-sizing: border-box; display: inline-block; max-width: max-content; padding: 2px 8px; width: max-content;"><p class="message-accent-info-text" id="message-accent-info-text" style="color: #2540f2; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 14px; font-weight: normal; line-height: 26px; margin: 0 5px 0 0 !important; padding: 0; text-align: left; white-space: nowrap;">Repository Stars:</p><p class="message-info-text" id="message-info-text" style="color: #2540f2; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 14px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: nowrap;">{self.repo.stargazers_count}</p></div></th></tr></tbody></table></th><th class="message-repo-info-forks small-6 large-6 columns last" id="message-repo-info-forks" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 20px; text-align: left; vertical-align: top; width: 274px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: end; vertical-align: top; word-wrap: break-word;"><div class="message-info-item" id="message-info-item" style="border: 2px solid #2335f3; border-radius: 30px; box-sizing: border-box; display: inline-block; max-width: max-content; padding: 2px 8px; width: max-content;"><p class="message-accent-info-text" id="message-accent-info-text" style="color: #2540f2; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 14px; font-weight: normal; line-height: 26px; margin: 0 5px 0 0 !important; padding: 0; text-align: left; white-space: nowrap;">Repository Forks:</p><p class="message-info-text" id="message-info-text" style="color: #2540f2; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 14px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: nowrap;">{self.repo.forks_count}</p></div></th></tr></tbody></table></th></tr></tbody></table>'
        message_text = message_text + f'<table class="row message-progressbar-header" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="message-progressbar-header-title small-6 large-6 columns first" id="message-progressbar-header-title" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 10px; text-align: left; vertical-align: top; width: 274px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><p class="message-progressbar-header-text" id="message-progressbar-header-text" style="color: #2540f2; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: nowrap;">Organization:</p></th></tr></tbody></table></th><th class="message-progressbar-header-value small-5 large-5 columns last" id="message-progressbar-header-value" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 10px; text-align: left; vertical-align: top; width: 225.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: end; vertical-align: top; word-wrap: break-word;"><p class="message-progressbar-header-text" id="message-progressbar-header-text" style="color: #2540f2; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: nowrap;">{organizations_percent}% ({organizations_total} profile(s))</p></th></tr></tbody></table></th></tr></tbody></table>'
        message_text = message_text + f'<table class="row message-progressbar" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="message-progressbar-wrapper small-12 large-12 columns first last" id="message-progressbar-wrapper" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 20px; text-align: left; vertical-align: top; width: 564px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><div class="message-progressbar-track" style="background-color: #fff; border: 2px solid #2335f3; border-radius: 30px; box-sizing: border-box; height: 30px; padding: 3px; width: 100%;"><div class="message-progressbar-progress" style="width: {organizations_percent}%; background-color: #2335f3; border-radius: 24px; height: 100%;"></div></div></th><th class="expander" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0 !important; text-align: left; vertical-align: top; visibility: hidden; width: 0; word-wrap: break-word;"></th></tr></tbody></table></th></tr></tbody></table>'
        message_text = message_text + f'<table class="row message-progressbar-header" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="message-progressbar-header-title small-6 large-6 columns first" id="message-progressbar-header-title" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 10px; text-align: left; vertical-align: top; width: 274px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><p class="message-progressbar-header-text" id="message-progressbar-header-text" style="color: #2540f2; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: nowrap;">Email users:</p></th></tr></tbody></table></th><th class="message-progressbar-header-value small-5 large-5 columns last" id="message-progressbar-header-value" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 10px; text-align: left; vertical-align: top; width: 225.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: end; vertical-align: top; word-wrap: break-word;"><p class="message-progressbar-header-text" id="message-progressbar-header-text" style="color: #2540f2; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: nowrap;">{users_with_email_percent}% ({users_with_email} profile(s))</p></th></tr></tbody></table></th></tr></tbody></table>'
        message_text = message_text + f'<table class="row message-progressbar" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="message-progressbar-wrapper small-12 large-12 columns first last" id="message-progressbar-wrapper" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 20px; text-align: left; vertical-align: top; width: 564px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><div class="message-progressbar-track" style="background-color: #fff; border: 2px solid #2335f3; border-radius: 30px; box-sizing: border-box; height: 30px; padding: 3px; width: 100%;"><div class="message-progressbar-progress" style="width: {users_with_email_percent}%; background-color: #2335f3; border-radius: 24px; height: 100%;"></div></div></th><th class="expander" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0 !important; text-align: left; vertical-align: top; visibility: hidden; width: 0; word-wrap: break-word;"></th></tr></tbody></table></th></tr></tbody></table>'
        message_text = message_text + f'<table class="row message-progressbar-header" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="message-progressbar-header-title small-6 large-6 columns first" id="message-progressbar-header-title" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 10px; text-align: left; vertical-align: top; width: 274px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><p class="message-progressbar-header-text" id="message-progressbar-header-text" style="color: #2540f2; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: nowrap;">Active users:</p></th></tr></tbody></table></th><th class="message-progressbar-header-value small-5 large-5 columns last" id="message-progressbar-header-value" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 10px; text-align: left; vertical-align: top; width: 225.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: end; vertical-align: top; word-wrap: break-word;"><p class="message-progressbar-header-text" id="message-progressbar-header-text" style="color: #2540f2; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: nowrap;">{"%.2f" % (active_users / (total_users) * 100)}% ({active_users} profile(s))</p></th></tr></tbody></table></th></tr></tbody></table>'
        message_text = message_text + f'<table class="row message-progressbar" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="message-progressbar-wrapper small-12 large-12 columns first last" id="message-progressbar-wrapper" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 20px; text-align: left; vertical-align: top; width: 564px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><div class="message-progressbar-track" style="background-color: #fff; border: 2px solid #2335f3; border-radius: 30px; box-sizing: border-box; height: 30px; padding: 3px; width: 100%;"><div class="message-progressbar-progress" style="width: {"%.2f" % (active_users / (total_users) * 100)}%; background-color: #2335f3; border-radius: 24px; height: 100%;"></div></div></th><th class="expander" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0 !important; text-align: left; vertical-align: top; visibility: hidden; width: 0; word-wrap: break-word;"></th></tr></tbody></table></th></tr></tbody></table>'
        message_text = message_text + f'<table class="row message-progressbar-header" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="message-progressbar-header-title small-6 large-6 columns first" id="message-progressbar-header-title" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 10px; text-align: left; vertical-align: top; width: 274px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><p class="message-progressbar-header-text" id="message-progressbar-header-text" style="color: #2540f2; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: nowrap;">Real users:</p></th></tr></tbody></table></th><th class="message-progressbar-header-value small-5 large-5 columns last" id="message-progressbar-header-value" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 10px; text-align: left; vertical-align: top; width: 225.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: end; vertical-align: top; word-wrap: break-word;"><p class="message-progressbar-header-text" id="message-progressbar-header-text" style="color: #2540f2; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: nowrap;">{"%.2f" % (real_users / (total_users) * 100)}% ({real_users} profile(s))</p></th></tr></tbody></table></th></tr></tbody></table>'
        message_text = message_text + f'<table class="row message-progressbar" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="message-progressbar-wrapper small-12 large-12 columns first last" id="message-progressbar-wrapper" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 20px; text-align: left; vertical-align: top; width: 564px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><div class="message-progressbar-track" style="background-color: #fff; border: 2px solid #2335f3; border-radius: 30px; box-sizing: border-box; height: 30px; padding: 3px; width: 100%;"><div class="message-progressbar-progress" style="width: {"%.2f" % (real_users / (total_users) * 100)}%; background-color: #2335f3; border-radius: 24px; height: 100%;"></div></div></th><th class="expander" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0 !important; text-align: left; vertical-align: top; visibility: hidden; width: 0; word-wrap: break-word;"></th></tr></tbody></table></th></tr></tbody></table>'
        
        email_org_name = ""
        email_organization_percent = ""
        email_organization_percent_text = ""

        for organization in company_summary:
            if organization.count > 3:
                organization_percent = "%.2f" % (organization.count / (total_users) * 100)
                email_organization_percent = email_organization_percent + organization_percent
                email_org_name = email_org_name + f'@{organization.company}'
                email_organization_percent_text = email_organization_percent_text + f'{organization_percent} % ({organization.count} profile(s))'

        if email_org_name and email_organization_percent and email_organization_percent_text:
            message_text = message_text + f'<table class="row message-progressbar-header" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="message-progressbar-header-title small-6 large-6 columns first" id="message-progressbar-header-title" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 10px; text-align: left; vertical-align: top; width: 274px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><p class="message-progressbar-header-text" id="message-progressbar-header-text" style="color: #2540f2; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: nowrap;">Org breakdown: {email_org_name}</p></th></tr></tbody></table></th><th class="message-progressbar-header-value small-5 large-5 columns last" id="message-progressbar-header-value" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 10px; text-align: left; vertical-align: top; width: 225.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: end; vertical-align: top; word-wrap: break-word;"><p class="message-progressbar-header-text" id="message-progressbar-header-text" style="color: #2540f2; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: nowrap;">{email_organization_percent_text}</p></th></tr></tbody></table></th></tr></tbody></table>'
            message_text = message_text + f'<table class="row message-progressbar" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="message-progressbar-wrapper small-12 large-12 columns first last" id="message-progressbar-wrapper" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 20px; text-align: left; vertical-align: top; width: 564px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><div class="message-progressbar-track" style="background-color: #fff; border: 2px solid #2335f3; border-radius: 30px; box-sizing: border-box; height: 30px; padding: 3px; width: 100%;"><div class="message-progressbar-progress" style="width: {email_organization_percent}%; background-color: #2335f3; border-radius: 24px; height: 100%;"></div></div></th><th class="expander" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0 !important; text-align: left; vertical-align: top; visibility: hidden; width: 0; word-wrap: break-word;"></th></tr></tbody></table></th></tr></tbody></table>'

        # issues chart
        issues_history_dict = json.loads(self.repo.issues_history)

        if issues_history_dict:
            issues_chart_labels = sorted(issues_history_dict.keys())
            issues_chart_dataset_opened = [issues_history_dict[key]["opened"] for key in issues_chart_labels]
            issues_chart_dataset_closed = [issues_history_dict[key]["closed"] for key in issues_chart_labels]
            issues_chart_data = {
                "type": "bar",
                "data": {
                    "labels": issues_chart_labels[data_limit:],
                    "datasets": [
                        {
                            "label": "Opened issues",
                            "data": issues_chart_dataset_opened[data_limit:],
                            "backgroundColor": "#8efbe1",
                            "barPercentage": 0.4,
                        },
                        {
                            "label": "Closed issues",
                            "data": issues_chart_dataset_closed[data_limit:],
                            "backgroundColor": "#2335f3",
                            "barPercentage": 0.4,
                        }
                    ]
                },
                "options": {
                    "legend": { 
                        "labels": {
                            "fontColor": '#2335f3'
                        },
                        "position": 'top',
                        "align": 'end'
                    },
                    "scales": {
                        "xAxes": [{
                            "gridLines": {
                                "display": False
                            },
                            "ticks": {
                                "fontColor": '#2335f3',
                            },
                        }],
                        "yAxes": [{
                            "ticks": {
                                "fontColor": '#2335f3',
                            },
                        }]
                    },
                    "plugins": {
                        "roundedBars": True 
                    }
                }
            }

            issues_chart_data_str = json.dumps(issues_chart_data)
            issues_chart_encoded_data = urllib.parse.quote(issues_chart_data_str)
            issues_chart_data_url = f"https://quickchart.io/chart?width=800&height=350&devicePixelRatio=1&c={issues_chart_encoded_data}"

            issues_chart_data_string = json.dumps(issues_chart_data)

            message_text = message_text + f'<table class="row message-issues" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="message-issues-chart-wrapper small-12 large-12 columns first last" id="message-issues-chart-wrapper" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0 auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 20px; text-align: left; vertical-align: top; width: 564px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><img class="message-issues-chart" id="message-issues-chart" src="{issues_chart_data_url}" alt="issues-chart" style="-ms-interpolation-mode: bicubic; clear: both; display: block; max-width: 100%; outline: none; text-decoration: none; width: 100%;"></th><th class="expander" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0 !important; text-align: left; vertical-align: top; visibility: hidden; width: 0; word-wrap: break-word;"></th></tr></tbody></table></th></tr></tbody></table>'
        
        message_text = message_text + f'<table class="row message-repo-health" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="message-repo-health-title small-4 large-4 columns first" id="message-repo-health-title" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 20px; text-align: left; vertical-align: middle; width: 177.3333333333px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><p class="message-accent-info-text" id="message-accent-info-text" style="color: #2540f2; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 14px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: nowrap;">In last 12 month:</p></th></tr></tbody></table></th><th class="message-repo-health-items small-8 large-8 columns last" id="message-repo-health-items" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 20px; text-align: left; vertical-align: top; width: 370.6666666667px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: end; vertical-align: top; word-wrap: break-word;"><div class="message-repo-health-item-group" id="message-repo-health-item-group"><div class="message-info-item" id="message-info-item" style="border: 2px solid #2335f3; border-radius: 30px; box-sizing: border-box; display: inline-block; max-width: max-content; padding: 2px 8px; width: max-content;"><p class="message-accent-info-text" id="message-accent-info-text" style="color: #2540f2; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 14px; font-weight: normal; line-height: 26px; margin: 0 5px 0 0 !important; padding: 0; text-align: left; white-space: nowrap;">Issues:</p><p class="message-info-text" id="message-info-text" style="color: #2540f2; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 14px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: nowrap;">{self.repo.issues_opened_ltm}</p></div><div class="message-info-item" id="message-info-item" style="border: 2px solid #2335f3; margin-left: 5px; border-radius: 30px; box-sizing: border-box; display: inline-block; max-width: max-content; padding: 2px 8px; width: max-content;"><p class="message-accent-info-text" id="message-accent-info-text" style="color: #2540f2; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 14px; font-weight: normal; line-height: 26px; margin: 0 5px 0 0 !important; padding: 0; text-align: left; white-space: nowrap;">Health:</p><p class="message-info-text" id="message-info-text" style="color: #2540f2; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 14px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: nowrap;">{self.repo.health}% issues closed</p></div></div></th></tr></tbody></table></th></tr></tbody></table>'

        if len(country_summary) > 1:
            message_text = message_text + f'<table class="row greeting" id="message-greeting" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th id="message-greeting-wrapper" class="small-12 large-12 columns first last" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0 0 20px; text-align: left; vertical-align: top; width: 100%; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;"><p id="message-main-text" class="main-text" style="margin: 0; color: #000000; display: inline-block; font-family: Brutal Type, sans-serif; font-size: 16px; font-weight: normal; line-height: 26px; margin: 0 !important; padding: 0; text-align: left; white-space: wrap;">Geo breakdown:</p></th><th class="expander" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0 !important; text-align: left; vertical-align: top; visibility: hidden; width: 0; word-wrap: break-word;"></th></tr></tbody></table></th></tr></tbody></table>'

        if len(country_summary) > 1 and len(country_summary) < 50:
            country_list = ''

            for location in country_summary:
                if location.country:
                    location_percent = "%.2f" % (location.count / total_users * 100)
                    country_list = country_list + f'<p class="message-location-text" id="message-location-text" style="color: #272727; font-family: Brutal Type, sans-serif; font-size: 14px; font-weight: normal; line-height: 1.3; margin: 0 !important; padding: 0; text-align: left; white-space: nowrap;">{location.country}: {location_percent} % ({location.count} profile(s))</p>'

            message_text = message_text + f'<table class="row message-location-full" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="message-location-full-wrapper small-12 large-12 columns first last" id="message-location-full-wrapper" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0; text-align: left; vertical-align: top; width: 564px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;">{country_list}</th><th class="expander" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0; border-collapse: collapse !important; box-sizing: border-box; color: #0a0a0a; font-family: Helvetica, Arial, sans-serif; font-size: 16px; font-weight: normal; hyphens: auto; line-height: 1.3; margin: 0; padding: 0 !important; text-align: left; vertical-align: top; visibility: hidden; width: 0; word-wrap: break-word;"></th></tr></tbody></table></th></tr></tbody></table>'
        
        if len(country_summary) > 49:
            left_country_list = ''
            right_country_list = ''

            first_half = country_summary[:50]
            second_half = country_summary[51:]


            for location in first_half:
                if location.country:
                    location_percent = "%.2f" % (location.count / total_users * 100)
                    left_country_list = left_country_list + f'<p class="message-location-text" id="message-location-text" style="color: #272727; font-family: Brutal Type, sans-serif; font-size: 14px; font-weight: normal; line-height: 1.3; margin: 0 !important; padding: 0; text-align: left; white-space: nowrap;">{location.country}: {location_percent} % ({location.count} profile(s))</p>'
            
            for location in second_half:
                if location.country:
                    location_percent = "%.2f" % (location.count / total_users * 100)
                    right_country_list = right_country_list + f'<p class="message-location-text" id="message-location-text" style="color: #272727; font-family: Brutal Type, sans-serif; font-size: 14px; font-weight: normal; line-height: 1.3; margin: 0 !important; padding: 0; text-align: left; white-space: nowrap;">{location.country}: {location_percent} % ({location.count} profile(s))</p>'
                    
            message_text = message_text + f'<table class="row message-location-half" style="border-collapse: collapse; border-spacing: 0; display: table; padding: 0; position: relative; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th class="message-location-left-wrapper small-6 large-6 columns first" id="message-location-left-wrapper" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0 auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0;  text-align: left; vertical-align: top; width: 274px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;">{left_country_list}</th></tr></tbody></table></th><th class="message-location-right-wrapper small-6 large-6 columns last" id="message-location-right-wrapper" style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; background-color: #fff; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0 auto; padding: 0; text-align: left; vertical-align: top; width: 274px; word-wrap: break-word;"><table style="border-collapse: collapse; border-spacing: 0; padding: 0; text-align: left; vertical-align: top; width: 100%;"><tbody><tr style="padding: 0; text-align: left; vertical-align: top;"><th style="-moz-box-sizing: border-box; -moz-hyphens: auto; -webkit-box-sizing: border-box; -webkit-hyphens: auto; Margin: 0; border-collapse: collapse !important; box-sizing: border-box; hyphens: auto; line-height: 1.3; margin: 0; padding: 0; text-align: left; vertical-align: top; word-wrap: break-word;">{right_country_list}</th></tr></tbody></table></th></tr></tbody></table>'

        # PDF report content

        # FIXME: Add the actual base URL from customer`s server for logos
        report_content = '<div class="report-header report__header"><img class="report-header__main-logo" src="http://127.0.0.1:8000/static/img/main-logo.png" alt="main-logo"><img src="http://127.0.0.1:8000/static/img/extra-logo.png" alt="extra-logo" class="report-header__extra-logo"></div>'
        report_content = report_content + f'<p class="report-text report-text_mb_30">Hi, there! Below (and attached) is your report for repository <a class="report-repo-link" href="https://github.com/{self.repo.name}">https://github.com/{self.repo.name}</a></p>'
        report_content = report_content + "<p class='report-text report-text_nowrap report-text_mb_30'>Thanks for using repoInspector! <a class='report-star-link' href='https://github.com/HetzVentures/repoInspector'>Give us a Star</a></p>"

        def report_setting_status(v):
            # FIXME: Add the actual base URL from customer`s server for icons
            return "http://127.0.0.1:8000/static/img/check-icon.png" if v else "http://127.0.0.1:8000/static/img/cross-icon.png"

        report_summary_content = f"<p class='report-settings__text'>Settings:</p> \
            <div class='report-settings__item'><img class='report-settings__icon' src={report_setting_status(settings['stars'])} alt='check-icon'><p class='report-settings__text'>Stars</p></div> \
            <div class='report-settings__item'><img class='report-settings__icon'  src={report_setting_status(settings['forks'])} alt='check-icon'><p class='report-settings__text'>Forks</p></div> \
            <div class='report-settings__item'><img class='report-settings__icon'  src={report_setting_status(settings['sample'])} alt='cross-icon'><p class='report-settings__text'>Sample</p></div>"
        report_content = report_content + f'<div class="report-field report-field_mb_30 report-summary"><p class="report-text report-summary__text">Summary</p><div class="report-settings">{report_summary_content}</div></div>'

        if settings.get('sample'):
            report_content = report_content + f"<div class='report-field report-field_mb_30'><p class='report-text report-text_nowrap'>Sample percent:</p><span class='report-value'>{settings['samplePercent']}%</span></div>"

        report_content = report_content + f'<div class="report-field report-field_mb_30"><p class="report-text report-text_nowrap">Total number of profiles inspected:</p><span class="report-value">{total_users}</span></div>'
        report_content = report_content + f'<div class="report-field report-field_mb_15"><p class="report-text report-text_nowrap">Issues:</p><span class="report-value">{self.repo.issues_count}</span></div>'
        report_content = report_content + f'<div class="report-field report-field_mb_15"><p class="report-text report-text_nowrap">Pull requests:</p><span class="report-value">{self.repo.pull_requests_count}</span></div>'
        report_content = report_content + f'<div class="report-field report-field_mb_15"><p class="report-text report-text_nowrap">Contributors:</p><span class="report-value">{self.repo.contributors_count}</span></div>'
        report_content = report_content + f'<div class="report-field report-field_mb_15"><p class="report-text report-text_nowrap">Watchers:</p><span class="report-value">{self.repo.watchers_count}</span></div>'
        report_content = report_content + f'<div class="report-field report-field_mb_15"><p class="report-text report-text_nowrap">Stars added per month:</p><span class="report-value">{stars_per_month}%</span></div>'
        report_content = report_content + f'<div class="report-field report-field_mb_15"><p class="report-text report-text_nowrap">Total forks / total stars:</p><span class="report-value">{round(self.repo.forks_count / self.repo.stargazers_count, 2)}</span></div>'
        report_content = report_content + f'<div class="report-field report-field_mb_30"><p class="report-text report-text_nowrap">Pull requests merged LTM:</p><span class="report-value">{self.repo.pull_requests_merged_ltm}</span></div>'
        
        # REPO RATING FIELD
        report_content = report_content + f'<div class="report-field report-field_mb_30"><p class="report-text report-text_nowrap report-text_blue">Repository rating:</p><span class="report-value report-value_blue">{repo_rating}</span></div>'

        if settings.get('sample'):
            report_stars_chart_data_url = f"https://quickchart.io/chart?width=950&height=350&devicePixelRatio=1&c={stars_chart_encoded_data}"
        else:
            report_stars_chart_data_url = f"https://quickchart.io/chart?width=950&height=400&devicePixelRatio=1&c={stars_chart_encoded_data}"

        if stars_history_dict:
            report_content = report_content + f'<img class="report-stars-chart" src="{report_stars_chart_data_url}" alt="Stargazers history chart">'
        
        report_content = report_content + f'<div class="report-field report-field_mb_30"><div class="report-info-item report-info-item_left"><p class="report-info-item__text">Repository Stars: <span class="report-info-item__value">{self.repo.stargazers_count}</span></p></div><div class="report-info-item report-info-item_right"><p class="report-info-item__text">Repository Forks: <span class="report-info-item__value">{self.repo.forks_count}</span></p></div></div>'

        if stars_history_dict:   
            report_content = report_content + '<div class="report-header report__header"><img class="report-header__main-logo" src="http://127.0.0.1:8000/static/img/main-logo.png" alt="main-logo"><img src="http://127.0.0.1:8000/static/img/extra-logo.png" alt="extra-logo" class="report-header__extra-logo"></div>'
        
        def render_radial_chart_center_area(title, percents, count):
            return f'<div class="report-radial-chart-content"><p class="report-radial-chart-content__title">{title}</p><p class="report-radial-chart-content__text">{percents}%</p><p class="report-radial-chart-content__text">({count} profile(s))</p></div>'
        
        def create_radial_chart_data(val):
            radial_chart_data = {
                "type": "radialGauge",
                "data": {
                    "datasets": [
                        {
                            "data": [val],
                            'backgroundColor': '#2335f3',
                        }
                    ]
                },
                "options": {
                    "domain": [0, 100],
                    "trackColor": '#f0f8ff', 
                    "centerPercentage": 90,
                    "centerArea": {
                        "displayText": False, 
                    },
                }
            }
            radial_chart_data_str = json.dumps(radial_chart_data)
            radial_chart_encoded_data = urllib.parse.quote(radial_chart_data_str)
            radial_chart_data_url = f"https://quickchart.io/chart?width=350&height=350&devicePixelRatio=1&c={radial_chart_encoded_data}"

            return radial_chart_data_url
        
        org_radial_chart_content = render_radial_chart_center_area(title='Organization:',percents=organizations_percent,count=organizations_total)
        email_users_radial_chart_content = render_radial_chart_center_area(title='Email users:',percents=users_with_email_percent,count=users_with_email)

        report_content = report_content + f'<div class="report-radial-charts-group"><div class="report-radial-chart-wrapper"><img class="report-radial-chart" src="{create_radial_chart_data(organizations_percent)}" alt="Organization radial chart">{org_radial_chart_content}</div><div class="report-radial-chart-wrapper report-radial-chart-wrapper_ml"><img class="report-radial-chart" src="{create_radial_chart_data(users_with_email_percent)}" alt="Email users radial chart">{email_users_radial_chart_content}</div></div>'
        report_content = report_content + f'<div class="report-progressbar report-progressbar_mb_30"><div class="report-progressbar__header"><p class="report-text report-text_nowrap report-text_blue">Active users:</p><span class="report-value report-value_blue">{"%.2f" % (active_users / (total_users) * 100)}% ({active_users} profile(s))</span></div><div class="report-progressbar__track"><div class="report-progressbar__progress" style="width: {"%.2f" % (active_users / (total_users) * 100)}%"></div></div></div>'

        report_org_name = ""
        report_organization_percent = ""
        report_organization_percent_text = ""

        for organization in company_summary:
            if organization.count > 3:
                organization_percent = "%.2f" % (organization.count / (total_users) * 100)
                report_organization_percent = report_organization_percent + organization_percent
                report_org_name = report_org_name + f'@{organization.company}'
                report_organization_percent_text = report_organization_percent_text + f'{organization_percent} % ({organization.count} profile(s))'

        if report_org_name and report_organization_percent and report_organization_percent_text:
            report_content = report_content + f'<div class="report-progressbar report-progressbar_mb_30"><div class="report-progressbar__header"><p class="report-text report-text_nowrap report-text_blue">Real users:</p><span class="report-value report-value_blue">{"%.2f" % (real_users / (total_users) * 100)}% ({real_users} profile(s))</span></div><div class="report-progressbar__track"><div class="report-progressbar__progress" style="width: {"%.2f" % (real_users / (total_users) * 100)}%"></div></div></div>'
            report_content = report_content + f'<div class="report-progressbar report-progressbar_mb_40"><div class="report-progressbar__header"><p class="report-text report-text_nowrap report-text_blue">Org breakdown: {report_org_name}</p><span class="report-value report-value_blue">{report_organization_percent_text}</span></div><div class="report-progressbar__track"><div class="report-progressbar__progress" style="width: {report_organization_percent}%"></div></div></div>'
        else: 
            report_content = report_content + f'<div class="report-progressbar report-progressbar_mb_40"><div class="report-progressbar__header"><p class="report-text report-text_nowrap report-text_blue">Real users:</p><span class="report-value report-value_blue">{"%.2f" % (real_users / (total_users) * 100)}% ({real_users} profile(s))</span></div><div class="report-progressbar__track"><div class="report-progressbar__progress" style="width: {"%.2f" % (real_users / (total_users) * 100)}%"></div></div></div>'

        report_issues_chart_data_url = f"https://quickchart.io/chart?width=950&height=400&devicePixelRatio=1&c={issues_chart_encoded_data}"

        if issues_history_dict:
            report_content = report_content + f'<img class="report-issues-chart" src="{report_issues_chart_data_url}" alt="Issues history chart"><br>'
            report_content = report_content + f'<div class="report-field report-field_mb_100"><p class="report-info-item__text">In last 12 month:</p><div class="report-field-item-group"><div class="report-info-item"><p class="report-info-item__text">Issues: <span class="report-info-item__value">{self.repo.issues_opened_ltm}</span></p></div><div class="report-info-item report-info-item_ml_20"><p class="report-info-item__text">Health: <span class="report-info-item__value">{self.repo.health}% issues closed</span></p></div></div></div>'
            
        else:
            report_content = report_content + f'<div class="report-field report-field_mb_30"><p class="report-info-item__text">In last 12 month:</p><div class="report-field-item-group"><div class="report-info-item"><p class="report-info-item__text">Issues: <span class="report-info-item__value">{self.repo.issues_opened_ltm}</span></p></div><div class="report-info-item report-info-item_ml_20"><p class="report-info-item__text">Health: <span class="report-info-item__value">{self.repo.health}% issues closed</span></p></div></div></div>'

        if len(country_summary) > 1 and issues_history_dict:
            report_content = report_content + '<div class="report-header report__header"><img class="report-header__main-logo" src="http://127.0.0.1:8000/static/img/main-logo.png" alt="main-logo"><img src="http://127.0.0.1:8000/static/img/extra-logo.png" alt="extra-logo" class="report-header__extra-logo"></div>'
            report_content = report_content + '<p class="report-text report-text_nowrap report-text_mb_30 report-text_blue">Geo breakdown:</p>'

        if len(country_summary) > 1 and len(country_summary) < 50:
            country_list = ''

            for location in country_summary:
                if location.country:
                    location_percent = "%.2f" % (location.count / total_users * 100)
                    country_list = country_list + f'<p class="report-location-text">{location.country}: {location_percent} % ({location.count} profile(s))</p>'

            report_content = report_content + country_list
        
        if len(country_summary) > 49:
            left_country_list = ''
            right_country_list = ''

            first_half = country_summary[:50]
            second_half = country_summary[51:]


            for location in first_half:
                if location.country:
                    location_percent = "%.2f" % (location.count / total_users * 100)
                    left_country_list = left_country_list + f'<p class="report-location-text">{location.country}: {location_percent} % ({location.count} profile(s))</p>'
            
            for location in second_half:
                if location.country:
                    location_percent = "%.2f" % (location.count / total_users * 100)
                    right_country_list = right_country_list + f'<p class="report-location-text">{location.country}: {location_percent} % ({location.count} profile(s))</p>'
                    
            report_content = report_content + f'<div class="report-location"><div class="report-location-wrapper">{left_country_list}</div><div class="report-location-wrapper report-location-wrapper_ml">{right_country_list}</div></div>'

        return message_text, report_content
